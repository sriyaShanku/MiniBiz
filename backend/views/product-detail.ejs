<%- include('partials/header', {
    title: title || (product ? 'MiniBiz | ' + product.name : 'MiniBiz | Product Detail'),
    description: product ? (product.short_description || (product.description ? product.description.substring(0,155) : 'View product details on MiniBiz.')) : 'View product details on MiniBiz.'
}) %>

<main class="section-padding">
    <div class="container">
        <p style="margin-bottom: 25px;"><a href="/product-listings">« Back to Listings</a></p>

        <%- include('partials/flash-messages') %>

        <% if (locals.product) { %>
            <div class="product-detail-layout">
                <!-- Product Images -->
                <section class="product-images">
                    <img src="<%= product.image_url || '/images/default-product.png' %>" alt="<%= product.name %>" id="main-product-image" style="max-height: 500px; width:100%; object-fit: cover; border-radius: var(--border-radius); box-shadow: var(--box-shadow); border: 1px solid var(--border-color);">
                    <% if (locals.product.thumbnails && product.thumbnails.length > 0) { %>
                         <div class="thumbnails" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-top: 15px;">
                            <% product.thumbnails.forEach(thumb => { %>
                                <img src="<%= thumb.url %>" alt="<%= thumb.alt || 'Thumbnail for ' + product.name %>" style="cursor: pointer; border: 2px solid var(--border-color); border-radius: 5px; width:100%; height: 80px; object-fit: cover;" onclick="changeMainImage(this.src)"> <%# Simpler changeMainImage, no need for original path %>
                            <% }); %>
                        </div>
                     <% } %>
                </section>

                <!-- Product Information -->
                <section class="product-info card">
                    <h1><%= product.name %></h1>
                    <p class="seller-link text-muted" style="margin-bottom: 20px;">
                        Sold by: <a href="/seller-profile/<%= product.seller_user_id %>"><strong><%= product.seller_display_name %></strong></a>
                    </p>
                    <div class="price">
                        <% if (typeof product.price === 'number' && product.price >= 0) { %> <%# Allow free (0) %>
                            <%= product.price.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }) %>
                            <% if (product.price_unit) { %> <%= product.price_unit %><% } %>
                        <% } else if (product.price && String(product.price).toLowerCase().includes('from')) { %>
                            <%= product.price %>
                        <% } else if (product.price && String(product.price).toLowerCase().includes('inquire')) { %>
                            Inquire for Price
                        <% } else if (product.is_service && !product.price) { %>
                            Inquire for Service Rates
                        <% } else { %>
                            Price not listed
                        <% } %>
                    </div>

                    <p><%= product.short_description || (product.description ? product.description.split('\n')[0].substring(0, 200) + (product.description.length > 200 || product.description.includes('\n') ? '...' : '') : 'More details below.') %></p>

                    <% if (locals.product.key_features && product.key_features.length > 0) { %>
                         <h4>Key Features:</h4>
                         <ul style="list-style: disc; padding-left: 25px; margin-bottom: 25px;">
                            <% product.key_features.forEach(feature => { %>
                                <li><%- feature %></li> <%# Using unescaped output for feature here %>
                            <% }); %>
                         </ul>
                    <% } %>

                    <div class="product-actions" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <% if (!product.is_service && typeof product.price === 'number' && product.price >= 0) { %> <%# Allow add to cart for free items too %>
                            <button class='btn btn-primary btn-cart'
                                 data-product-id='<%= product.id %>'
                                 data-product-name='<%- product.name.replace(/'/g, "&#39;").replace(/"/g, "&quot;") %>'
                                 data-product-price='<%= product.price %>'
                                 data-product-image='<%= product.image_url || "/images/default-product.png" %>'>
                                 <i class="fa-solid fa-cart-plus"></i> Add to Cart
                             </button>
                        <% } %>

                        <% if (product.is_service || (product.price && String(product.price).toLowerCase().includes('inquire')) ) { %>
                             <button class='btn btn-secondary btn-book'
                                 data-service-name='<%- product.name.replace(/'/g, "&#39;").replace(/"/g, "&quot;") %>'
                                 data-service-id='<%= product.id %>'
                                 data-seller-id='<%= product.seller_user_id %>'>
                                 <i class="fa-solid fa-calendar-check"></i>
                                 <%= product.is_service ? 'Book Service' : 'Inquire First' %>
                             </button>
                        <% } %>

                         <button class='btn btn-outline-primary contact-seller-btn'
                            style="border-color: var(--primary-color); color: var(--primary-color);"
                            data-seller-id='<%= product.seller_user_id %>'
                            data-seller-name='<%- product.seller_display_name.replace(/'/g, "&#39;").replace(/"/g, "&quot;") %>'
                            data-product-name='<%- product.name.replace(/'/g, "'").replace(/"/g, "&quot;") %>'
                            data-product-id='<%= product.id %>'
                            onclick="openContactModal(this)">
                            <i class="fa-solid fa-comments"></i> Contact Seller
                        </button>
                     </div>
                </section>
            </div> <!-- End Product Detail Layout -->

            <section class="product-description card section-padding-sm">
                 <h2>More About This <%= product.is_service ? 'Service' : 'Product' %></h2><hr style="margin-bottom: 20px;">
                 <div class="content-area">
                    <%- product.description ? product.description.replace(/\n/g, '<br><br>') : 'Full description not available.' %> <%# Replaced \n with double <br> for paragraphs %>
                 </div>

                 <% if (locals.product.ordering_process && product.ordering_process.length > 0) { %>
                    <h4 style="margin-top: 20px;">Ordering Process:</h4>
                    <ol style="list-style: decimal; padding-left: 25px; margin-bottom: 15px;">
                       <% product.ordering_process.forEach(step => { %>
                           <li><%- step %></li>
                       <% }); %>
                    </ol>
                    <p class="text-muted">Please order at least 2 weeks in advance for custom designs. Check availability for rush orders.</p>
                 <% } %>
            </section>

            <% if (locals.relatedProducts && relatedProducts.length > 0) { %>
                <section class="related-products section-padding-sm">
                    <h2 class="text-center">More from <%= product.seller_display_name %></h2>
                     <div class="product-grid" style="margin-top: 30px;">
                        <% relatedProducts.forEach(relProduct => { %>
                            <article class="product-card card">
                                <a href="/product-detail/<%= relProduct.id %>" class="product-image-link">
                                    <img src="<%= relProduct.image_url || '/images/default-product.png' %>" alt="<%= relProduct.name %>" style="height:180px; object-fit:cover; border-bottom: 1px solid var(--border-color);">
                                </a>
                                <div class="product-card-content">
                                    <h3><a href="/product-detail/<%= relProduct.id %>"><%= relProduct.name %></a></h3>
                                    <div class="price">
                                        <% if (typeof relProduct.price === 'number' && relProduct.price >= 0) { %>
                                            <%= relProduct.price.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 }) %>
                                        <% } else { %>
                                            <%= relProduct.price %>
                                        <% } %>
                                    </div>
                                    <a href="/product-detail/<%= relProduct.id %>" class="btn btn-secondary btn-sm"><%= relProduct.is_service ? 'View Service' : 'View Details' %></a>
                                </div>
                            </article>
                        <% }); %>
                     </div>
                </section>
            <% } %>

        <% } else { %>
            <div class="text-center card" style="padding: 40px;">
                <i class="fa-solid fa-circle-exclamation fa-3x text-muted" style="margin-bottom: 15px;"></i>
                <p class="lead text-muted">Product not found or information is unavailable.</p>
                <a href="/product-listings" class="btn btn-primary" style="margin-top: 20px;">Back to Listings</a>
            </div>
        <% } %>
    </div>
</main>

<!-- Contact Seller Modal ... -->
<!-- Booking Inquiry Modal ... -->
<!-- (Modal HTML structures remain the same as previous correct version) -->
<div id="contact-seller-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content card">
       <button class="modal-close-btn" onclick="closeContactModal()">×</button>
       <h3>Contact <span id="modal-contact-seller-name-placeholder">Seller</span></h3>
       <p class="text-muted">Send your inquiry about <strong id="modal-contact-product-name-placeholder">this item</strong> directly.</p>
       <hr style="margin: 15px 0; border-color: var(--border-color);">
      <form id="modal-contact-form">
          <input type="hidden" id="modal-contact-seller-id-input" name="seller_id">
          <input type="hidden" id="modal-contact-product-id-input" name="product_id">
           <div class="form-group">
               <label for="modal-contact-message">Your Message *</label>
               <textarea id="modal-contact-message" name="message_body" rows="5" required placeholder="Ask about availability, customization, etc..."></textarea>
           </div>
           <% if (!locals.user) { %>
               <div class="form-group">
                   <label for="modal-contact-email">Your Email (for reply) *</label>
                   <input type="email" id="modal-contact-email" name="reply_email" required placeholder="Your email address">
               </div>
           <% } else { %>
                <input type="hidden" id="modal-contact-email" name="reply_email" value="<%= user.email %>">
                <p class="text-muted" style="font-size: 0.85em;">Your message will be sent using your registered email: <%= user.email %></p>
           <% } %>
           <button type="submit" class="btn btn-primary" style="width: 100%;">Send Message</button>
       </form>
       <p id="modal-contact-form-status" style="text-align: center; margin-top: 15px; display: none;"></p>
    </div>
</div>

<div id="booking-modal" class="modal-overlay" style="display:none;">
   <div class="modal-content card">
       <button class="modal-close-btn" onclick="closeBookingModal()">×</button>
       <h3>Booking Inquiry: <span id="modal-booking-service-title-placeholder">[Service Name]</span></h3>
       <p class="text-muted">Send inquiry for this service.</p>
       <hr style="margin: 15px 0; border-color: var(--border-color);">
       <form id="booking-form">
           <input type="hidden" id="booking-service-id-input" name="service_id">
           <input type="hidden" id="booking-seller-id-input" name="seller_id_for_service">
           <div class="form-group">
                <label for="booking-date">Preferred Date *</label>
                <input type="date" id="booking-date" name="booking_date" required min="<%= new Date().toISOString().split('T')[0] %>">
            </div>
           <div class="form-group">
               <label for="booking-time">Preferred Time (Optional)</label>
               <input type="time" id="booking-time" name="booking_time">
           </div>
           <div class="form-group">
               <label for="booking-details">Details/Message *</label>
               <textarea id="booking-details" name="booking_details" rows="4" required placeholder="Any specific requirements or questions?"></textarea>
           </div>
          <% if (locals.user) { %>
               <input type="hidden" id="booking-name" name="name" value="<%= user.full_name %>">
               <input type="hidden" id="booking-email" name="email" value="<%= user.email %>">
               <p class="text-muted" style="font-size:0.85em">Your name (<%= user.full_name %>) and email will be sent with this inquiry.</p>
          <% } else { %>
               <div class="form-group">
                  <label for="booking-name">Your Name *</label>
                  <input type="text" id="booking-name" name="name" required>
              </div>
              <div class="form-group">
                   <label for="booking-email">Your Email *</label>
                   <input type="email" id="booking-email" name="email" required placeholder="Your email address">
              </div>
          <% } %>
           <button type="submit" class="btn btn-primary" style="width: 100%;">Send Inquiry</button>
       </form>
       <p id="booking-form-status" style="text-align: center; margin-top: 15px; display: none;"></p>
   </div>
</div>

<%
const pageScripts = [];
%>
<%- include('partials/footer', { pageScripts: pageScripts }) %>